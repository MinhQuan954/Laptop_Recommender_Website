<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Laptop Recommender{% endblock %}</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
  
  <!-- Meta tags for better SEO and social sharing -->
  <meta name="description" content="H·ªá th·ªëng g·ª£i √Ω laptop th√¥ng minh - T√¨m laptop ph√π h·ª£p v·ªõi nhu c·∫ßu v√† ng√¢n s√°ch c·ªßa b·∫°n">
  <meta name="keywords" content="laptop, g·ª£i √Ω, so s√°nh, mua laptop, laptop gaming, laptop vƒÉn ph√≤ng">
  <meta name="author" content="Laptop Recommender">
  
  <!-- Open Graph tags -->
  <meta property="og:title" content="Laptop Recommender">
  <meta property="og:description" content="H·ªá th·ªëng g·ª£i √Ω laptop th√¥ng minh">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.url }}">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>
<body class="app-gradient">
<!-- Navbar v·ªõi scroll effect -->
<nav class="navbar navbar-expand-lg app-navbar border-bottom mb-3" id="mainNavbar">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">
      <span class="text-gradient">üíª</span> Laptop Recommender
    </a>
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link {{ 'active' if request.endpoint == 'laptops' }}" href="{{ url_for('laptops') }}">
            <span class="nav-icon">üì±</span> Danh s√°ch
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {{ 'active' if request.endpoint == 'compare' }}" href="{{ url_for('compare') }}">
            <span class="nav-icon">‚öñÔ∏è</span> So s√°nh
          </a>
        </li>
        {% if current_user.is_authenticated %}
        <li class="nav-item">
          <a class="nav-link {{ 'active' if request.endpoint == 'favorites' }}" href="{{ url_for('favorites') }}">
            <span class="nav-icon">‚ù§Ô∏è</span> Y√™u th√≠ch
          </a>
        </li>
        {% endif %}
      </ul>
      
      <!-- Search form -->
      <form class="d-flex position-relative search-form" role="search" action="{{ url_for('laptops') }}" autocomplete="off">
        <input class="form-control search-input" id="navbarSearch" type="search" placeholder="T√¨m laptop..." name="q" aria-label="T√¨m ki·∫øm laptop">
        <button class="btn btn-primary search-btn" type="submit" aria-label="T√¨m ki·∫øm">
          <span class="search-icon">üîç</span>
        </button>
        <div id="searchSuggest" class="position-fixed search-suggest-container" style="display:none;"></div>
      </form>
      
      <!-- User menu -->
      <ul class="navbar-nav ms-3">
        {% if current_user.is_authenticated %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center user-menu" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="user-avatar">üë§</span>
            <span class="user-name">{{ current_user.username }}</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end animate-fade-in">
            <li><a class="dropdown-item" href="{{ url_for('profile') }}">üë§ H·ªì s∆°</a></li>
            <li><a class="dropdown-item" href="{{ url_for('favorites') }}">‚ù§Ô∏è Y√™u th√≠ch</a></li>
            {% if current_user.role == 'admin' %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_dashboard') }}">‚öôÔ∏è Qu·∫£n tr·ªã</a></li>
            {% endif %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('logout') }}">üö™ ƒêƒÉng xu·∫•t</a></li>
          </ul>
        </li>
        {% else %}
        <li class="nav-item">
          <a class="nav-link btn btn-outline-primary btn-sm me-2" href="{{ url_for('login') }}">
            <span class="btn-icon">üîë</span> ƒêƒÉng nh·∫≠p
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link btn btn-primary btn-sm" href="{{ url_for('register') }}">
            <span class="btn-icon">üìù</span> ƒêƒÉng k√Ω
          </a>
        </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- Main content container -->
<div class="container container-narrow">
  <!-- Flash messages v·ªõi animation -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show animate-fade-in-up" role="alert">
            <div class="d-flex align-items-center">
              <span class="alert-icon me-2">
                {% if category == 'success' %}‚úÖ
                {% elif category == 'danger' %}‚ùå
                {% elif category == 'warning' %}‚ö†Ô∏è
                {% else %}‚ÑπÔ∏è
                {% endif %}
              </span>
              <span>{{ message }}</span>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  
  <!-- Main content -->
  <main class="main-content">
    {% block content %}{% endblock %}
  </main>
</div>

<!-- Footer -->
<footer class="footer mt-5 py-4">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <h6 class="text-gradient fw-bold mb-3">Laptop Recommender</h6>
        <p class="text-muted mb-0">H·ªá th·ªëng g·ª£i √Ω laptop th√¥ng minh gi√∫p b·∫°n t√¨m ƒë∆∞·ª£c s·∫£n ph·∫©m ph√π h·ª£p nh·∫•t.</p>
      </div>
              <div class="col-md-6 text-md-end">
          <p class="text-muted mb-0">
           2025 Laptop Recommender. ƒê∆∞·ª£c ph√°t tri·ªÉn v·ªõi ‚ù§Ô∏è
          </p>
          <p class="text-muted mb-0">
           Web ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi m·ª•c ƒë√≠ch h·ªçc t·∫≠p ‚ù§Ô∏è
          </p>
        </div>
    </div>
  </div>
</footer>

<!-- Back to top button -->
<button id="backToTop" class="back-to-top" aria-label="L√™n ƒë·∫ßu trang">
  <span>‚Üë</span>
</button>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script>
// Navbar scroll effect
window.addEventListener('scroll', function() {
  const navbar = document.getElementById('mainNavbar');
  if (window.scrollY > 50) {
    navbar.classList.add('scrolled');
  } else {
    navbar.classList.remove('scrolled');
  }
});

// Back to top button
const backToTopBtn = document.getElementById('backToTop');

window.addEventListener('scroll', function() {
  if (window.scrollY > 300) {
    backToTopBtn.classList.add('show');
  } else {
    backToTopBtn.classList.remove('show');
  }
});

backToTopBtn.addEventListener('click', function() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
});

// Function to update back to top button position
function updateBackToTopPosition() {
  const compareBtn = document.getElementById('showCompareBtn');
  if (compareBtn && compareBtn.style.display !== 'none') {
    backToTopBtn.classList.add('with-compare');
  } else {
    backToTopBtn.classList.remove('with-compare');
  }
}

// Observer to watch for compare button changes
const compareButtonObserver = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
      updateBackToTopPosition();
    }
  });
});

// Start observing the compare button if it exists
document.addEventListener('DOMContentLoaded', function() {
  const compareBtn = document.getElementById('showCompareBtn');
  if (compareBtn) {
    compareButtonObserver.observe(compareBtn, {
      attributes: true,
      attributeFilter: ['style']
    });
  }
});

// Search functionality v·ªõi c·∫£i ti·∫øn
(function(){
  const input = document.getElementById('navbarSearch');
  const container = document.getElementById('searchSuggest');
  if (!input || !container) return;

  let abortCtrl = null;
  let hideTimer = null;

  function formatPrice(v){
    try { 
      return new Intl.NumberFormat('vi-VN').format(v) + ' VND'; 
    } catch(e) { 
      return v + ' VND'; 
    }
  }

  function escapeRegExp(s){ 
    return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
  }
  
  function highlight(text, q){
    if (!q) return text;
    try {
      const re = new RegExp(escapeRegExp(q), 'ig');
      return text.replace(re, (m) => `<mark class="px-1 py-0">${m}</mark>`);
    } catch(e){ 
      return text; 
    }
  }
  
  function render(items){
    const rect = input.getBoundingClientRect();
    container.style.left = rect.left + 'px';
    container.style.top = (rect.bottom + 5) + 'px';
    container.style.width = rect.width + 'px';
    container.style.zIndex = '999999999';
    container.style.position = 'fixed';
    container.style.backgroundColor = 'white';
    container.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
    container.style.border = '1px solid #ddd';
    container.style.borderRadius = '12px';
    container.style.overflow = 'hidden';
    
    if (!items || items.length === 0){
      container.innerHTML = `
        <div class="card app-card mt-1">
          <div class="p-3 text-muted text-center">
            <span class="search-no-results">üîç</span>
            <div>Kh√¥ng c√≥ s·∫£n ph·∫©m ph√π h·ª£p</div>
          </div>
        </div>`;
      container.style.display = 'block';
      return;
    }
    
    const html = `
      <div class="card app-card mt-1" style="max-height: 360px; overflow:auto;">
        <div class="list-group list-group-flush">
          ${items.map(it => `
            <a href="/laptop/${it.id}" class="list-group-item list-group-item-action d-flex align-items-center search-item">
              <img src="${it.image_url || '/static/images/R.webp'}" alt="${it.name}" 
                   style="width:48px;height:32px;object-fit:cover;" class="me-2 rounded border">
              <div class="flex-grow-1">
                <div class="fw-semibold search-item-title">${highlight(it.name, input.value.trim())}</div>
                <div class="small text-muted search-item-price">${formatPrice(it.price)}</div>
              </div>
              <span class="search-item-arrow">‚Üí</span>
            </a>
          `).join('')}
        </div>
      </div>`;
    container.innerHTML = html;
    container.style.display = 'block';
  }

  async function fetchSuggest(q){
    if (abortCtrl) abortCtrl.abort();
    abortCtrl = new AbortController();
    
    const timestamp = new Date().getTime();
    const url = `/api/search_suggest?q=${encodeURIComponent(q)}&limit=3&_t=${timestamp}`;
    
    try {
      const res = await fetch(url, { 
        signal: abortCtrl.signal,
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });
      const data = await res.json();
      render(data.items || []);
    } catch(e){ 
      console.error('Search error:', e);
    }
  }

  let debounce;
  input.addEventListener('input', function(){
    const q = this.value.trim();
    clearTimeout(debounce);
    
    if (q.length < 2){
      container.style.display = 'none';
      container.innerHTML = '';
      return;
    }
    debounce = setTimeout(() => fetchSuggest(q), 180);
  });

  input.addEventListener('focus', function(){
    if (container.innerHTML.trim()) container.style.display = 'block';
  });

  input.addEventListener('blur', function(){
    hideTimer = setTimeout(() => { container.style.display = 'none'; }, 150);
  });

  container.addEventListener('mousedown', function(e){
    e.preventDefault();
    if (hideTimer) clearTimeout(hideTimer);
  });

  container.addEventListener('click', function(e){
    e.stopPropagation();
  });

  // Responsive search suggest positioning
  function updateSearchPosition() {
    if (container.style.display === 'block') {
      const rect = input.getBoundingClientRect();
      container.style.left = rect.left + 'px';
      container.style.top = (rect.bottom + 5) + 'px';
      container.style.width = rect.width + 'px';
    }
  }

  window.addEventListener('scroll', updateSearchPosition);
  window.addEventListener('resize', updateSearchPosition);
})();

// Smooth animations cho c√°c elements
document.addEventListener('DOMContentLoaded', function() {
  // Animate elements khi load trang
  const animateElements = document.querySelectorAll('.animate-fade-in-up, .animate-fade-in, .animate-slide-in-right');
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, {
    threshold: 0.1
  });
  
  animateElements.forEach(el => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(20px)';
    el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    observer.observe(el);
  });
});

// Cache management
window.addEventListener('beforeunload', function() {
  if (typeof(Storage) !== "undefined") {
    console.log('Clearing cache before navigation...');
  }
});

window.addEventListener('load', function() {
  if (typeof(Storage) !== "undefined") {
    console.log('Page loaded, cache cleared');
  }
});
</script>

<!-- Additional CSS for new features -->
<style>
/* Navbar improvements */
.nav-icon {
  margin-right: 0.5rem;
  font-size: 1.1em;
}

.user-avatar {
  margin-right: 0.5rem;
  font-size: 1.2em;
}

.user-name {
  font-weight: 600;
}

/* Search form improvements */
.search-form {
  position: relative;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.search-input {
  border-radius: 25px;
  border: 2px solid var(--border);
  padding: 0.75rem 1rem;
  min-width: 250px;
  transition: all 0.3s ease;
}

.search-input:focus {
  border-color: var(--primary-500);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  outline: none;
}

.search-btn {
  border-radius: 50%;
  width: 45px;
  height: 45px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  transition: all 0.3s ease;
}

.search-btn:hover {
  transform: scale(1.05);
}

.search-icon {
  font-size: 1.1rem;
}

@media (max-width: 768px) {
  .search-input {
    min-width: 200px;
  }
}

@media (max-width: 576px) {
  .search-input {
    min-width: 150px;
  }
}

/* Search suggest improvements */
.search-item {
  transition: all 0.2s ease;
}

.search-item:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(240, 147, 251, 0.05) 100%);
  transform: translateX(4px);
}

.search-item-title {
  font-weight: 600;
  color: var(--text-strong);
}

.search-item-price {
  color: var(--primary-600);
  font-weight: 500;
}

.search-item-arrow {
  color: var(--text-muted);
  font-weight: bold;
  opacity: 0;
  transition: all 0.2s ease;
}

.search-item:hover .search-item-arrow {
  opacity: 1;
  transform: translateX(4px);
}

.search-no-results {
  font-size: 2rem;
  display: block;
  margin-bottom: 0.5rem;
}

/* Alert improvements */
.alert-icon {
  font-size: 1.2em;
}

.flash-messages {
  position: fixed;
  top: 100px;
  right: 20px;
  z-index: 9999;
  max-width: 400px;
}

/* Back to top button */
.back-to-top {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--gradient-primary);
  color: white;
  border: none;
  box-shadow: var(--shadow-lg);
  cursor: pointer;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 1000;
  font-size: 1.2rem;
  font-weight: bold;
}

.back-to-top.show {
  opacity: 1;
  visibility: visible;
}

.back-to-top.show.with-compare {
  bottom: 100px;
}

.back-to-top:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-xl);
}

/* Footer */
.footer {
  background: var(--gradient-card);
  border-top: 1px solid var(--border);
  margin-top: auto;
}

/* Dropdown improvements */
.dropdown-menu {
  border-radius: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  padding: 0.5rem;
}

.dropdown-item {
  border-radius: 8px;
  padding: 0.75rem 1rem;
  transition: all 0.2s ease;
}

.dropdown-item:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(240, 147, 251, 0.05) 100%);
  transform: translateX(4px);
}

/* Button improvements */
.btn-icon {
  margin-right: 0.5rem;
}

/* Responsive improvements */
@media (max-width: 768px) {
  .flash-messages {
    position: static;
    max-width: 100%;
  }
  
  .back-to-top {
    bottom: 20px;
    right: 20px;
    width: 45px;
    height: 45px;
  }
}
</style>

{% block scripts %}{% endblock %}
</body>
</html>
