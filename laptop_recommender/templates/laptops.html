{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    {% if recommendation_type %}
    <div class="alert alert-info">
        <h5>Kết quả gợi ý cho nhu cầu: <strong>{{ recommendation_type|title }}</strong></h5>
        <p class="mb-0">Dưới đây là những laptop phù hợp nhất với nhu cầu của bạn, được sắp xếp theo mức độ phù hợp.</p>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Danh sách sản phẩm</h4>
        <div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">Quay lại trang chủ</a>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        {% for it in items %}
        <div class="col">
            <div class="card h-100 app-card product-card" data-product-id="{{ it.id }}" style="cursor: pointer;">
                <img src="{{ it.image_url or 'https://via.placeholder.com/400x250?text=Laptop' }}" 
                     class="card-img-top" alt="{{ it.name }}">
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title">{{ it.name }}</h6>
                    
                    <!-- Thông tin cấu hình -->
                    <div class="small text-muted mb-2">
                        <div><strong>Thương hiệu:</strong> {{ it.brand }}</div>
                        <div><strong>CPU:</strong> {{ it.cpu }}</div>
                        <div><strong>RAM:</strong> {{ it.ram_gb }}GB</div>
                        {% if it.gpu %}
                        <div><strong>GPU:</strong> {{ it.gpu }}</div>
                        {% endif %}
                        <div><strong>Storage:</strong> {{ it.storage }}</div>
                        <div><strong>Màn hình:</strong> {{ it.screen }}</div>
                    </div>
                    
                    <div class="mt-auto">
                        <div class="fw-bold mb-2 text-primary fs-5">{{ "{:,.0f}".format(it.price) }} VND</div>
                        <div class="d-flex gap-2">
                            <a class="btn btn-sm btn-primary flex-fill" href="{{ url_for('laptop_detail', laptop_id=it.id) }}">
                                Xem chi tiết
                            </a>
                            <button class="btn btn-sm btn-outline-secondary compare-btn" 
                                    data-laptop-id="{{ it.id }}" 
                                    data-laptop-name="{{ it.name }}">
                                Chọn so sánh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if not items %}
    <div class="alert alert-info mt-3">
        <h5>Không có kết quả phù hợp</h5>
        <p class="mb-0">Hãy thử điều chỉnh các tiêu chí tìm kiếm hoặc mở rộng ngân sách để có thêm lựa chọn.</p>
    </div>
    {% endif %}
</div>

<!-- Modal chọn laptop so sánh -->
<div class="modal fade" id="compareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn laptop để so sánh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="selectedLaptops" class="mb-3">
                    <h6>Laptop đã chọn:</h6>
                    <div id="selectedList" class="d-flex flex-wrap gap-2"></div>
                </div>
                <div class="alert alert-info">
                    <small>Chọn ít nhất 2 laptop để so sánh (tối đa 4 laptop)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="compareBtn" disabled>So sánh</button>
            </div>
        </div>
    </div>
</div>

<!-- Floating compare button -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
    <button class="compare-fab" id="showCompareBtn" style="display: none;">
        <span>So sánh</span>
        <span class="compare-count" id="compareCount">0</span>
    </button>
</div>

<script>
let selectedLaptops = [];

document.addEventListener('DOMContentLoaded', function() {
    // Xử lý nút chọn so sánh
    document.querySelectorAll('.compare-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Ngăn chặn event bubbling
            const laptopId = this.dataset.laptopId;
            const laptopName = this.dataset.laptopName;
            
            if (selectedLaptops.find(l => l.id === laptopId)) {
                // Bỏ chọn
                selectedLaptops = selectedLaptops.filter(l => l.id !== laptopId);
                this.textContent = 'Chọn so sánh';
                this.classList.remove('btn-success');
                this.classList.add('btn-outline-secondary');
            } else {
                // Chọn
                if (selectedLaptops.length >= 4) {
                    alert('Chỉ có thể chọn tối đa 4 laptop để so sánh!');
                    return;
                }
                selectedLaptops.push({id: laptopId, name: laptopName});
                this.textContent = 'Đã chọn';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-success');
            }
            
            updateCompareUI();
        });
    });

    // Xử lý click vào card sản phẩm
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function(e) {
            // Không chuyển hướng nếu click vào nút
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('button') || e.target.closest('a')) {
                return;
            }
            
            const productId = this.dataset.productId;
            // Xóa cache trước khi chuyển trang
            if (typeof(Storage) !== "undefined") {
                localStorage.removeItem('selectedLaptops');
                sessionStorage.clear();
            }
            window.location.href = `/laptop/${productId}`;
        });
    });
    
    // Xử lý nút so sánh
    document.getElementById('compareBtn').addEventListener('click', function() {
        if (selectedLaptops.length >= 2) {
            const ids = selectedLaptops.map(l => l.id).join('&id=');
            window.location.href = `/compare?id=${ids}`;
        }
    });
    
    // Xử lý nút floating
    document.getElementById('showCompareBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('compareModal'));
        modal.show();
    });
});

function updateCompareUI() {
    const selectedList = document.getElementById('selectedList');
    const compareBtn = document.getElementById('compareBtn');
    const showCompareBtn = document.getElementById('showCompareBtn');
    
    // Cập nhật danh sách đã chọn
    selectedList.innerHTML = '';
    selectedLaptops.forEach(laptop => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-2';
        badge.textContent = laptop.name;
        selectedList.appendChild(badge);
    });
    
    // Cập nhật trạng thái nút
    compareBtn.disabled = selectedLaptops.length < 2;
    
    // Hiển thị/ẩn nút floating
    if (selectedLaptops.length > 0) {
        showCompareBtn.style.display = 'inline-flex';
        document.getElementById('compareCount').textContent = selectedLaptops.length;
        // hiệu ứng bump
        showCompareBtn.classList.remove('bump');
        void showCompareBtn.offsetWidth; // reflow để reset animation
        showCompareBtn.classList.add('bump');
    } else {
        showCompareBtn.style.display = 'none';
    }
}
</script>
{% endblock %}
